"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _winston = require("winston");

var _winston2 = _interopRequireDefault(_winston);

var _slackNotify = require("slack-notify");

var _slackNotify2 = _interopRequireDefault(_slackNotify);

var _urlParse = require("url-parse");

var _urlParse2 = _interopRequireDefault(_urlParse);

var _moment = require("moment");

var _moment2 = _interopRequireDefault(_moment);

var _uncaught_exception = require("./transports/uncaught_exception");

var _uncaught_exception2 = _interopRequireDefault(_uncaught_exception);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Yodelay {
  constructor(params) {
    this.slackUrl = params.slackUrl;
    this.level = params.level || "debug";
    this.format = params.format;
    this.slack = (0, _slackNotify2.default)(this.slackUrl);
    this.channel = params.channel;
    this.appName = params.appName;
    this.kibanaUrl = params.kibanaUrl;
    this.alertOnError = params.alertOnError || true;
  }

  initialize() {
    const group = _winston2.default.createLogger({
      level: this.level
    });

    _winston2.default.loggers.add(this.appName, group);

    const logger = _winston2.default.loggers.get(this.appName);

    this.setFormat(logger);

    this.logger = logger;

    this.logger.error = this.error;
    this.logger.info = this.info;
    this.logger.debug = this.debug;
    this.logger.buildKibanaUrl = this.buildKibanaUrl;
    this.logger.slack = this.slack;
    this.logger.appName = this.appName;
    this.logger.kibanaUrl = this.kibanaUrl;
    this.logger.channel = this.channel;
    this.logger.alertOnError = this.alertOnError;
    this.logger.level = this.level;

    logger.exceptions.handle(new _uncaught_exception2.default({
      logger: this.logger
    }));

    return this.logger;
  }

  debug(msg) {
    if (this.level === "error" || this.level === "debug") {
      this.log({ app: this.appName, message: msg, level: "debug" });
    }
  }

  info(msg) {
    this.log({ app: this.appName, message: msg, level: "info" });
  }

  error(err) {
    if (this.level === "error" || this.level === "debug") {
      this.log({ app: this.appName, message: err, level: "error" });
    }

    if (process.env.NODE_ENV !== "development" && this.alertOnError) {
      this.slack.send({
        channel: this.channel,
        text: `:warning: Error Happened ${(0, _moment2.default)().calendar()}`,
        fields: {
          Application: this.appName,
          "Error Message": err,
          ":chart_with_upwards_trend: Kibana Url": this.buildKibanaUrl(this.kibanaUrl, (0, _moment2.default)())
        }
      });
    }
  }

  buildKibanaUrl(url, time) {
    const dateFrom = time.subtract(1, "minute").format();
    const dateTo = time.add(1, "minute").format();

    return `${url}#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:${dateFrom},mode:absolute,to:${dateTo}))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,negate:!f,params:(query:${this.appName},type:phrase),type:phrase,value:${this.appName}))),interval:auto,query:(language:lucene,query:'Unhandled%20Rejection'),sort:!('@timestamp',desc))`;
  }

  simpleBaseFormat() {
    const base = _winston2.default.format.printf(function (info) {
      return `${info.timestamp} [${info.app}] ${info.level}: ${info.message}`;
    });

    return _winston2.default.format.combine(_winston2.default.format.timestamp(), base);
  }

  setFormat(logger) {
    const simpleBase = this.simpleBaseFormat();

    switch (this.format) {
      case "json":
        logger.add(new _winston2.default.transports.Console({
          format: _winston2.default.format.combine(_winston2.default.format.timestamp(), _winston2.default.format.json())
        }));

        break;
      case "simple":
        logger.add(new _winston2.default.transports.Console({
          format: _winston2.default.format.combine(_winston2.default.format.colorize(), _winston2.default.format.simple(), simpleBase)
        }));

        break;
      default:
        logger.add(new _winston2.default.transports.Console({
          format: _winston2.default.format.combine(_winston2.default.format.colorize(), _winston2.default.format.simple(), simpleBase)
        }));
    }
  }
}

exports.default = Yodelay;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJZb2RlbGF5IiwiY29uc3RydWN0b3IiLCJwYXJhbXMiLCJzbGFja1VybCIsImxldmVsIiwiZm9ybWF0Iiwic2xhY2siLCJjaGFubmVsIiwiYXBwTmFtZSIsImtpYmFuYVVybCIsImFsZXJ0T25FcnJvciIsImluaXRpYWxpemUiLCJncm91cCIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsb2dnZXJzIiwiYWRkIiwibG9nZ2VyIiwiZ2V0Iiwic2V0Rm9ybWF0IiwiZXJyb3IiLCJpbmZvIiwiZGVidWciLCJidWlsZEtpYmFuYVVybCIsImV4Y2VwdGlvbnMiLCJoYW5kbGUiLCJVbmNhdWdodEV4Y2VwdGlvblRyYW5zcG9ydCIsIm1zZyIsImxvZyIsImFwcCIsIm1lc3NhZ2UiLCJlcnIiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJzZW5kIiwidGV4dCIsImNhbGVuZGFyIiwiZmllbGRzIiwiQXBwbGljYXRpb24iLCJ1cmwiLCJ0aW1lIiwiZGF0ZUZyb20iLCJzdWJ0cmFjdCIsImRhdGVUbyIsInNpbXBsZUJhc2VGb3JtYXQiLCJiYXNlIiwicHJpbnRmIiwidGltZXN0YW1wIiwiY29tYmluZSIsInNpbXBsZUJhc2UiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsImpzb24iLCJjb2xvcml6ZSIsInNpbXBsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7Ozs7O0FBRUEsTUFBTUEsT0FBTixDQUFjO0FBQ1pDLGNBQVlDLE1BQVosRUFBb0I7QUFDbEIsU0FBS0MsUUFBTCxHQUFnQkQsT0FBT0MsUUFBdkI7QUFDQSxTQUFLQyxLQUFMLEdBQWFGLE9BQU9FLEtBQVAsSUFBZ0IsT0FBN0I7QUFDQSxTQUFLQyxNQUFMLEdBQWNILE9BQU9HLE1BQXJCO0FBQ0EsU0FBS0MsS0FBTCxHQUFhLDJCQUFNLEtBQUtILFFBQVgsQ0FBYjtBQUNBLFNBQUtJLE9BQUws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QVFRLGtCQUFRUixNQUFSLENBQWU0QyxPQUFmLENBQ05wQyxrQkFBUVIsTUFBUixDQUFlaUQsUUFBZixFQURNLEVBRU56QyxrQkFBUVIsTUFBUixDQUFla0QsTUFBZixFQUZNLEVBR05MLFVBSE07QUFEcUIsU0FBL0IsQ0FERjs7QUFVQTtBQUNGO0FBQ0VqQyxlQUFPRCxHQUFQLENBQ0UsSUFBSUgsa0JBQVFzQyxVQUFSLENBQW1CQyxPQUF2QixDQUErQjtBQUM3Qi9DLGtCQUFRUSxrQkFBUVIsTUFBUixDQUFlNEMsT0FBZixDQUNOcEMsa0JBQVFSLE1BQVIsQ0FBZWlELFFBQWYsRUFETSxFQUVOekMsa0JBQVFSLE1BQVIsQ0FBZWtELE1BQWYsRUFGTSxFQUdOTCxVQUhNO0FBRHFCLFNBQS9CLENBREY7QUF6Qko7QUFtQ0Q7QUFySVc7O2tCQXdJQ2xELE8iLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgd2luc3RvbiBmcm9tIFwid2luc3RvblwiO1xuaW1wb3J0IHNsYWNrIGZyb20gXCJzbGFjay1ub3RpZnlcIjtcbmltcG9ydCBVcmwgZnJvbSBcInVybC1wYXJzZVwiO1xuaW1wb3J0IG1vbWVudCBmcm9tIFwibW9tZW50XCI7XG5cbmltcG9ydCBVbmNhdWdodEV4Y2VwdGlvblRyYW5zcG9ydCBmcm9tIFwiLi90cmFuc3BvcnRzL3VuY2F1Z2h0X2V4Y2VwdGlvblwiO1xuXG5jbGFzcyBZb2RlbGF5IHtcbiAgY29uc3RydWN0b3IocGFyYW1zKSB7XG4gICAgdGhpcy5zbGFja1VybCA9IHBhcmFtcy5zbGFja1VybDtcbiAgICB0aGlzLmxldmVsID0gcGFyYW1zLmxldmVsIHx8IFwiZGVidWdcIjtcbiAgICB0aGlzLmZvcm1hdCA9IHBhcmFtcy5mb3JtYXQ7XG4gICAgdGhpcy5zbGFjayA9IHNsYWNrKHRoaXMuc2xhY2tVcmwpO1xuICAgIHRoaXMuY2hhbm5lbCA9IHBhcmFtcy5jaGFubmVsO1xuICAgIHRoaXMuYXBwTmFtZSA9IHBhcmFtcy5hcHBOYW1lO1xuICAgIHRoaXMua2liYW5hVXJsID0gcGFyYW1zLmtpYmFuYVVybDtcbiAgICB0aGlzLmFsZXJ0T25FcnJvciA9IHBhcmFtcy5hbGVydE9uRXJyb3IgfHwgdHJ1ZTtcbiAgfVxuXG4gIGluaXRpYWxpemUoKSB7XG4gICAgY29uc3QgZ3JvdXAgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcih7XG4gICAgICBsZXZlbDogdGhpcy5sZXZlbFxuICAgIH0pO1xuXG4gICAgd2luc3Rvbi5sb2dnZXJzLmFkZCh0aGlzLmFwcE5hbWUsIGdyb3VwKTtcblxuICAgIGNvbnN0IGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQodGhpcy5hcHBOYW1lKTtcblxuICAgIHRoaXMuc2V0Rm9ybWF0KGxvZ2dlcik7XG5cbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblxuICAgIHRoaXMubG9nZ2VyLmVycm9yID0gdGhpcy5lcnJvcjtcbiAgICB0aGlzLmxvZ2dlci5pbmZvID0gdGhpcy5pbmZvO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnID0gdGhpcy5kZWJ1ZztcbiAgICB0aGlzLmxvZ2dlci5idWlsZEtpYmFuYVVybCA9IHRoaXMuYnVpbGRLaWJhbmFVcmw7XG4gICAgdGhpcy5sb2dnZXIuc2xhY2sgPSB0aGlzLnNsYWNrO1xuICAgIHRoaXMubG9nZ2VyLmFwcE5hbWUgPSB0aGlzLmFwcE5hbWU7XG4gICAgdGhpcy5sb2dnZXIua2liYW5hVXJsID0gdGhpcy5raWJhbmFVcmw7XG4gICAgdGhpcy5sb2dnZXIuY2hhbm5lbCA9IHRoaXMuY2hhbm5lbDtcbiAgICB0aGlzLmxvZ2dlci5hbGVydE9uRXJyb3IgPSB0aGlzLmFsZXJ0T25FcnJvcjtcbiAgICB0aGlzLmxvZ2dlci5sZXZlbCA9IHRoaXMubGV2ZWw7XG5cbiAgICBsb2dnZXIuZXhjZXB0aW9ucy5oYW5kbGUoXG4gICAgICBuZXcgVW5jYXVnaHRFeGNlcHRpb25UcmFuc3BvcnQoe1xuICAgICAgICBsb2dnZXI6IHRoaXMubG9nZ2VyXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5sb2dnZXI7XG4gIH1cblxuICBkZWJ1Zyhtc2cpIHtcbiAgICBpZiAodGhpcy5sZXZlbCA9PT0gXCJlcnJvclwiIHx8IHRoaXMubGV2ZWwgPT09IFwiZGVidWdcIikge1xuICAgICAgdGhpcy5sb2coeyBhcHA6IHRoaXMuYXBwTmFtZSwgbWVzc2FnZTogbXNnLCBsZXZlbDogXCJkZWJ1Z1wiIH0pO1xuICAgIH1cbiAgfVxuXG4gIGluZm8obXNnKSB7XG4gICAgdGhpcy5sb2coeyBhcHA6IHRoaXMuYXBwTmFtZSwgbWVzc2FnZTogbXNnLCBsZXZlbDogXCJpbmZvXCIgfSk7XG4gIH1cblxuICBlcnJvcihlcnIpIHtcbiAgICBpZiAodGhpcy5sZXZlbCA9PT0gXCJlcnJvclwiIHx8IHRoaXMubGV2ZWwgPT09IFwiZGVidWdcIikge1xuICAgICAgdGhpcy5sb2coeyBhcHA6IHRoaXMuYXBwTmFtZSwgbWVzc2FnZTogZXJyLCBsZXZlbDogXCJlcnJvclwiIH0pO1xuICAgIH1cblxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gXCJkZXZlbG9wbWVudFwiICYmIHRoaXMuYWxlcnRPbkVycm9yKSB7XG4gICAgICB0aGlzLnNsYWNrLnNlbmQoe1xuICAgICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWwsXG4gICAgICAgIHRleHQ6IGA6d2FybmluZzogRXJyb3IgSGFwcGVuZWQgJHttb21lbnQoKS5jYWxlbmRhcigpfWAsXG4gICAgICAgIGZpZWxkczoge1xuICAgICAgICAgIEFwcGxpY2F0aW9uOiB0aGlzLmFwcE5hbWUsXG4gICAgICAgICAgXCJFcnJvciBNZXNzYWdlXCI6IGVycixcbiAgICAgICAgICBcIjpjaGFydF93aXRoX3Vwd2FyZHNfdHJlbmQ6IEtpYmFuYSBVcmxcIjogdGhpcy5idWlsZEtpYmFuYVVybChcbiAgICAgICAgICAgIHRoaXMua2liYW5hVXJsLFxuICAgICAgICAgICAgbW9tZW50KClcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGJ1aWxkS2liYW5hVXJsKHVybCwgdGltZSkge1xuICAgIGNvbnN0IGRhdGVGcm9tID0gdGltZS5zdWJ0cmFjdCgxLCBcIm1pbnV0ZVwiKS5mb3JtYXQoKTtcbiAgICBjb25zdCBkYXRlVG8gPSB0aW1lLmFkZCgxLCBcIm1pbnV0ZVwiKS5mb3JtYXQoKTtcblxuICAgIHJldHVybiBgJHt1cmx9Iy9kaXNjb3Zlcj9fZz0ocmVmcmVzaEludGVydmFsOihkaXNwbGF5Ok9mZixwYXVzZTohZix2YWx1ZTowKSx0aW1lOihmcm9tOiR7ZGF0ZUZyb219LG1vZGU6YWJzb2x1dGUsdG86JHtkYXRlVG99KSkmX2E9KGNvbHVtbnM6IShfc291cmNlKSxmaWx0ZXJzOiEoKCckc3RhdGUnOihzdG9yZTphcHBTdGF0ZSksbWV0YTooYWxpYXM6IW4sZGlzYWJsZWQ6IWYsbmVnYXRlOiFmLHBhcmFtczoocXVlcnk6JHtcbiAgICAgIHRoaXMuYXBwTmFtZVxuICAgIH0sdHlwZTpwaHJhc2UpLHR5cGU6cGhyYXNlLHZhbHVlOiR7XG4gICAgICB0aGlzLmFwcE5hbWVcbiAgICB9KSkpLGludGVydmFsOmF1dG8scXVlcnk6KGxhbmd1YWdlOmx1Y2VuZSxxdWVyeTonVW5oYW5kbGVkJTIwUmVqZWN0aW9uJyksc29ydDohKCdAdGltZXN0YW1wJyxkZXNjKSlgO1xuICB9XG5cbiAgc2ltcGxlQmFzZUZvcm1hdCgpIHtcbiAgICBjb25zdCBiYXNlID0gd2luc3Rvbi5mb3JtYXQucHJpbnRmKGluZm8gPT4ge1xuICAgICAgcmV0dXJuIGAke2luZm8udGltZXN0YW1wfSBbJHtpbmZvLmFwcH1dICR7aW5mby5sZXZlbH06ICR7aW5mby5tZXNzYWdlfWA7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gd2luc3Rvbi5mb3JtYXQuY29tYmluZSh3aW5zdG9uLmZvcm1hdC50aW1lc3RhbXAoKSwgYmFzZSk7XG4gIH1cblxuICBzZXRGb3JtYXQobG9nZ2VyKSB7XG4gICAgY29uc3Qgc2ltcGxlQmFzZSA9IHRoaXMuc2ltcGxlQmFzZUZvcm1hdCgpO1xuXG4gICAgc3dpdGNoICh0aGlzLmZvcm1hdCkge1xuICAgICAgY2FzZSBcImpzb25cIjpcbiAgICAgICAgbG9nZ2VyLmFkZChcbiAgICAgICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICAgICAgICB3aW5zdG9uLmZvcm1hdC50aW1lc3RhbXAoKSxcbiAgICAgICAgICAgICAgd2luc3Rvbi5mb3JtYXQuanNvbigpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJzaW1wbGVcIjpcbiAgICAgICAgbG9nZ2VyLmFkZChcbiAgICAgICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICAgICAgICB3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLFxuICAgICAgICAgICAgICB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKSxcbiAgICAgICAgICAgICAgc2ltcGxlQmFzZVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBsb2dnZXIuYWRkKFxuICAgICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7XG4gICAgICAgICAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgICAgICAgIHdpbnN0b24uZm9ybWF0LmNvbG9yaXplKCksXG4gICAgICAgICAgICAgIHdpbnN0b24uZm9ybWF0LnNpbXBsZSgpLFxuICAgICAgICAgICAgICBzaW1wbGVCYXNlXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgWW9kZWxheTtcbiJdfQ==